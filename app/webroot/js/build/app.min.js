Catool=(function(){var e=Backbone.Model.extend({});var d=Backbone.View.extend({});var c=Backbone.Collection.extend({});var a=_.extend({},Backbone.Events);var b={id:null,isAdmin:false,isModerator:false,canModerate:function(f){return this.isModerator||this.id==f},set:function(f){_.extend(this,f)}};return{Model:e,View:d,Collection:c,Events:a,user:b,models:{},views:{},collections:{},utils:{}}})();(function(a){var c=function(d){if(!(this instanceof c)){return new c(d)}this.time=d;this._parsed=false;this._value={};return this};c.invalidText="Invalid format. Must be HH:MM:SS";c.prototype={numRe:/^(\d+)$/,numParts:["seconds"],formatRe:/^(?:(\d{1,3}):)?(\d{1,2}):(\d{2})(?:[.,](\d+))?$/,formatParts:["hours","minutes","seconds"],isValid:function(){return this.numRe.test(this.time)||this.formatRe.test(this.time)},parse:function(){if(typeof this.time==="number"||this.numRe.test(this.time)){this._parseNumber(Number(this.time))}else{if(typeof this.time==="string"){this._parseString(this.time)}}},_parseNumber:function(e){var g,d,f;g=Math.floor(e/3600);e-=g*3600;d=Math.floor(e/60);e-=d*60;f=Math.floor(e);this._value={hours:g,minutes:d,seconds:f};this._parsed=true},_parseString:function(g){var h=this.formatParts;var e=this.formatRe.exec(g);if(e){e.shift();for(var f=0,d=h.length;f<d;f++){this._value[h[f]]=Number(e[f]||0)}this._parsed=true}},_parseAndDo:function(d){if(!this._parsed){if(!this.isValid()){return null}this.parse()}return d.call(this,this._value)},toSeconds:function(){return this._parseAndDo(function(d){return(d.hours*3600)+(d.minutes*60)+d.seconds})},toString:function(){var d=function(e){var f=e?e+"":"";while(f.length<2){f="0"+f}return f};return this._parseAndDo(function(e){var f=[e.hours||"0",d(e.minutes),d(e.seconds)];return f.join(":")})}};var b=function(d){d=d||{};this.player=d.player};b.prototype={emptyTemplate:_.template('<div class="notes-empty">No annotations to display at this time (<%= total %> total).</div>'),initialize:function(d){this.container=d;this.collection=d.collection;this.lastCue=-1;this.container.on("toggleSync",this._onToggleSync,this);this.container.on("playNote",this._onPlayNote,this);if(d.syncEnabled){this.player.on("play",_.once(this.enableSync),this)}},enableSync:function(){this.syncEnabled=true;this._updateCuePoints();this.container.sortBy("start-time","desc");this.collection.on("add remove change fetch",this._updateCuePoints,this);this.player.on("cue cueready",this._showViewsAtCue,this)},disableSync:function(){this.syncEnabled=false;this.player.off("cue cueready",this._showViewsAtCue,this);this.collection.off("add remove change fetch",this._updateCuePoints,this);this._clearCuePoints();this._resetContainer()},_resetContainer:function(){this._removeEmptyText();_.each(this.container.views,function(d){d.show()})},_showViewsAtCue:function(l,h,e){var m=this.container.views;var j=m.length;var d=0;var f,k,g;for(f=0;f<j;f++){k=m[f];g=parseInt(k.model.get("segments").first().get("start_time"),10);if(g<e){k.collapse().show()}else{if(g==e){k.expand().show()}else{k.hide();d++}}}this._removeEmptyText();if(j===d){this._showEmptyText(j)}this.lastCue=e},_showEmptyText:function(d){this.container.$el.append(this.emptyTemplate({total:d}))},_removeEmptyText:function(){this.container.$(".notes-empty").remove()},_onToggleSync:function(d){this[d?"enableSync":"disableSync"]()},_onPlayNote:function(g,e){var f=g.get("segments");var h=f.first();var i=c(h.get("start_time")).toSeconds();var d=c(h.get("end_time")).toSeconds();if(i!==null&&d!==null){this.player.playSegment(i,d)}},_updateCuePoints:function(){this.cues=this._getCuePoints();this.player.cue(this.cues,{reset:true});if(this.lastCue>=0){this._showViewsAtCue(null,this.lastCue,this.lastCue)}},_clearCuePoints:function(){this.player.cue([],{reset:true});this.lastCue=-1},_getCuePoints:function(){var d=_(this.collection.getAnnotations()).map(function(e){var f=e.get("segments").first();return parseInt(f.get("start_time"),10)});return _.uniq(d).sort(function(f,e){return f-e})}};a.utils=_.extend(a.utils,{url:function(d){return d},nl2br:function(f,e){var d=(e||typeof e==="undefined")?"<br />":"<br>";return(f+"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1"+d+"$2")},TimeConverter:c,NoteSyncModel:b})})(Catool);(function(f){var e=f.Model;var h=f.Collection;var b=f.utils.url;var c=e.extend({idAttribute:"id"});f.models.Segment=c;var d=h.extend({model:c});f.collections.Segments=d;var i=e.extend({idAttribute:"id",initialize:function(){if(!this.get("fullname")){this.set({fullname:this.get("name")})}}});f.models.User=i;var a=f.Model.extend({idAttribute:"id",urlRoot:b("/notes"),initialize:function(){if(!this.get("tags")){this.set({tags:[]})}},parse:function(k){var l={};if(k.results){k=k.results}_.extend(l,k.Note);if(k.User){l.user=new i(k.User)}if(k.Segment){l.segments=new d(k.Segment)}return l},isAnnotation:function(){return this.get("type")==="annotation"},isComment:function(){return this.get("type")==="comment"},isCommentOn:function(k){return this.isComment()&&this.get("parent_id")===k.get("id")},getComments:function(){if(this.isAnnotation()){return this.collection.getCommentsFor(this)}return null},hasTags:function(){return this.get("tags").length>0}});f.models.Note=a;var g=h.extend({model:a,targetModel:null,initialize:function(l,k){this.targetModel=k.targetModel},parse:function(k){return k.results},fetch:function(k){var m,l;k=k||{};m=k.success;l=k.data;k.url=b("/notes?target_id="+this.targetModel.get("id"));k.success=_.bind(function(){if(m){m.apply(this,arguments)}this.trigger("fetch",this,l)},this);return h.prototype.fetch.call(this,k)},search:function(k){this.fetch({data:k})},getCommentsFor:function(k){var l=_(this.models).filter(function(m){return m.isCommentOn(k)});return l},getAnnotations:function(){return this.filter(function(k){return k.isAnnotation()})}});f.collections.Notes=g;var j=e.extend({idAttribute:"id",urlRoot:b("/videos")});f.models.Video=j})(Catool);(function(b){var d=b.View;var c=["success","error","info"];var a=d.extend({className:"alert fade in",template:_.template(['<a class="close" data-dismiss="alert">&times;</a>',"<%= message %>"].join("")),alerts:c,initialize:function(e){var f=e.msg||"";var g=e.hasOwnProperty("alert")?e.alert:null;if(g!==null&&_.indexOf(this.alerts,g)===-1){throw new Error("Invalid alert: ["+g+"] Must be one of: "+this.alerts.join(", "))}this.alert=g;this.message=f},render:function(){var e=this.template({message:this.message});this.$el.addClass(this.alert===null?"":"alert-"+this.alert).html(e).alert();return this},close:function(){this.$el.alert("close")}});a.msg=function(e){var g,f;if(e.hasOwnProperty("applyTo")){f=e.applyTo;delete e.applyTo}g=new a(e);g.render();if(typeof f!=="undefined"){f.html(g.el)}return g};_.each(c,function(e){a[e]=function(f){return a.msg({alert:e,msg:f})}});b.views.AlertView=a})(Catool);(function(b){var c=b.View;var a=c.extend({events:{"click .js-btn-save":"onSave","click .js-btn-cancel":"onCancel"},className:"note-text-editor",template:_.template(['<textarea style="margin-bottom: 10px; width: 95%"><%= content %></textarea>',"<p>",'<button class="js-btn-save btn-primary btn" style="margin-right: 10px">Save Changes</button>','<button class="js-btn-cancel btn">Cancel</button>',"</p>"].join("")),initialize:function(){this.minHeight=this.options.minHeight||50;this.maxHeight=this.options.maxHeight||500;this.save=this.options.save;this.cancel=this.options.cancel;this.setHeight(this.options.height||null);this.setContent(this.options.content||null)},setContent:function(d){this.content=d;return this},setHeight:function(f){var d=this.maxHeight,e=this.minHeight;if(_.isNumber(d)&&f>d){f=d}else{if(_.isNumber(e)&&f<e){f=e}}this.height=f;return this},render:function(){var e=this.template({content:this.content});var d=this.height;var g=this.options.minHeight||50;var f=this.options.maxHeight||250;this.$el.html(e);if(d){this.$el.children("textarea").height(d)}return this},onCancel:function(d){d.preventDefault();d.stopPropagation();this.cancel()},onSave:function(d){d.preventDefault();d.stopPropagation();var e=this.$el.children("textarea").val();this.save(e)},destroy:function(){this.remove();this.unbind()}});b.views.CommentEditorView=a})(Catool);(function(d){var b=d.models.Note;var f=d.View;var a=d.views.AlertView;var e=d.utils.TimeConverter;var c=f.extend({events:{"submit .note-form":"onSubmit","click button.cancel":"onCancel"},errorTemplate:_.template('<p class="help-block help-error"><%= msg %></p>'),initialize:function(h){var j=this.$("input[name=title]");var k=this.$("textarea[name=body]");var i=this.$("input[name=start_time]");var g=this.$("input[name=end_time]");var l=this.$("input[name=tags]");l.tagit();this.video=h.video;this.player=h.player;this.formErrors={};this.inputFields={Note:{title:j,body:k,tags:l},Segment:{start_time:i,end_time:g}};i.bind("keyup",this.onTimeFieldChange(0));g.bind("keyup",this.onTimeFieldChange(1));this.player.on("rangesliderchange",_.bind(this.onRangeSliderChange,this))},onRangeSliderChange:function(){var j=this.player.getPlugin("rangeslider");var h=j.currentStatus();var i=this.inputFields.Segment;var k=e(Math.round(h.values[0])).toString();var g=e(Math.round(h.values[1])).toString();i.start_time.val(k);i.end_time.val(g)},onTimeFieldChange:function(h){var g=this;return function(i){var k=e($(this).val()).toSeconds();var j=g.player.getPlugin("rangeslider");if(j&&!isNaN(k)){j.setValue(h,k)}}},onSubmit:function(g){var h=this;var i={};var j=new b();var k;g.preventDefault();this._foreachField(function(m,l,n){i[m]=i[m]||{};i[m][l]=n.val()});i.Note.type="annotation";i.Note.target_id=this.collection.targetModel.get("id");i.Note.title=i.Note.title||"Untitled";i.Segment=[i.Segment];this.unhighlightErrors();this.validateAnnotation(i);if(this.isValid()){_.each(["start_time","end_time"],function(l){i.Segment[0][l]=e(i.Segment[0][l]).toSeconds()});j.save(i,{error:_.bind(this.handleError,this),success:_.bind(this.handleSave,this)})}else{this.message({alert:"error",msg:"Annotation not saved"});this.highlightErrors()}},onCancel:function(g){g.preventDefault();this.clear();this.player.hideRangeSlider();this.trigger("cancel")},validateAnnotation:function(o){var n={};var l=o.Note.body||"";var j=o.Segment[0];var k=j.start_time;var g=j.end_time;var h=this.video.get("duration");var i=function(p){return e(p).isValid()};var m=function(q,p){return e(q).toSeconds()<=e(p).toSeconds()};if(i(k)&&i(g)){if(m(k,g)){if(!m(k,h)){n.start_time="Start time exceeds video duration"}if(!m(g,h)){n.end_time="End time exceeds video duration"}}else{n.start_time="Start time is greater than end time";n.end_time=""}}else{if(!i(k)){n.start_time=e.invalidText}if(!i(g)){n.end_time=e.invalidText}}if($.trim(l).length===0){n.body="Comment is empty"}this.formErrors=n},isValid:function(){return _.keys(this.formErrors).length===0},handleSave:function(h,g){this.collection.add(h);this.clear();this.message({alert:"success",msg:"Annotation saved"})},handleError:function(h,g){this.message({alert:"error",msg:"Annotation not saved"})},clear:function(){this.closeMessage();this.unhighlightErrors();this._foreachField(function(h,g,i){if(g==="tags"){i.tagit("removeAll")}i.val("")});this.onRangeSliderChange()},message:function(g){var h=this.$(".alert-messages");h.html(a.msg(g).el)},closeMessage:function(){this.$(".alert-messages .alert").remove()},highlightErrors:function(){var g=this;_.each(this.formErrors,function(j,h){var i=g.$(".control-group:has(*[name="+h+"])");i.addClass("error");i.find(".controls").filter(":first").append(g.errorTemplate({msg:j}))})},unhighlightErrors:function(){this.$(".control-group.error").removeClass("error");this.$(".help-error").remove()},_foreachField:function(i){var g=this;var h={};_.each(_(this.inputFields).keys(),function(k){var j=g.inputFields[k];_.each(j,function(l,m){i.call(this,k,m,l)})})}});d.views.VideoNoteFormView=c})(Catool);(function(c,b){var d=c.View;var a=d.extend({player:null,playerEvents:["loadstart","loadedmetadata","loadeddata","loadedalldata","play","pause","ended","durationchange","progress","resize","volumechange","error","fullscreenchange","rangesliderchange","rangeslidererror","rangesliderlock","rangesliderunlock"],initialize:function(e){this.playerId=e.playerId},render:function(){var e=this;var f={techOrder:["html5","youtube","flash"],plugins:["rangeslider"]};b(this.playerId,f,function(){e.player=this;e.onPlayerReady.apply(e,arguments)});return this},onPlayerReady:function(){this._relayPlayerEvents();this.trigger("ready",this)},_relayPlayerEvents:function(){var f=this;var e=function(g){return function(){var h=Array.prototype.slice.call(arguments);h.splice(0,0,g);f.trigger.apply(f,h)}};_.each(this.playerEvents,function(g){f.player.addEvent(g,e(g))})},playSegment:function(f,e){if(f!==null&&e!==null){this.initSegmentHandler(f,e);this.player.currentTime(f);this.player.play();this.showRangeSlider();this.setRangeSliderValues(f,e);this.lockRangeSlider()}},initSegmentHandler:function(f,e){this.clearSegmentHandler();this.segmentHandler=this.makeSegmentHandler(f,e);this.player.addEvent("timeupdate",this.segmentHandler)},clearSegmentHandler:function(){if(this.segmentHandler){this.player.removeEvent("timeupdate",this.segmentHandler);this.hideRangeSlider();this.unlockRangeSlider();this.segmentHandler=null}},makeSegmentHandler:function(k,e){var f=Math.floor(k);var g=Math.ceil(e)+1;var h=null;var i=_.bind(function(l){return _.bind(function(n){var m=this.player.currentTime();if(h===null||h===m){h=m}else{l.apply(this,arguments)}},this)},this);var j=function(n){var m=this.player.currentTime();var l=(m>=e&&m<=g);if(m==e||l){this.clearSegmentHandler();this.player.pause()}else{if(m<f||m>g){this.clearSegmentHandler()}}};return i(j)},cue:function(f,e){this.cues=this.cues||[];if(e.reset){this.cues=[]}this.cues=_.uniq(this.cues.concat(f)).sort(function(h,g){return h-g});if(this.cues.length>0){this.initCueHandler()}else{this.clearCueHandler()}},initCueHandler:function(){this.clearCueHandler();this.cueHandler=_.bind(this.onTimeCheckCuePoints,this);this.player.addEvent("timeupdate",this.cueHandler)},clearCueHandler:function(){if(this.cueHandler){this.player.removeEvent("timeupdate",this.cueHandler);this.cueHandler=null}this.cueIdx=-1;this.cueTime=-1;this.cueInit=false},onTimeCheckCuePoints:function(j){var h=this.player.currentTime();var f=this.cueIdx;var i=this.cueTime;var g;if(!this.cueInit){this.triggerCueReady(h);this.cueInit=true}if(f>=0&&h<i){this.triggerCue(h)}else{g=this.cues[f+1];if(typeof g!=="undefined"&&h>=g){this.triggerCue(h)}}},triggerCue:function(e){this.updateCuePoint(e);this.trigger("cue",this,e,this.cueTime)},triggerCueReady:function(e){this.trigger("cueready",this,e,Math.floor(e))},updateCuePoint:function(g){var e=-1;var f=this.findCueIndex(function(h){return h>g});if(f<0&&g>=_(this.cues).last()){e=this.cues.length-1}else{if(f>=0){e=f-1}}this.cueIdx=e;this.cueTime=e>=0?this.cues[e]:-1;this.nextCueTime=f>=0?this.cues[f]:-1},findCueIndex:function(h){var g,e=this.cues.length;var f=this.cues;for(g=0;g<e;g++){if(h(f[g])){return g}}return -1},getPlugin:function(e){return this.player.getPlugin(e)},rangeSliderDo:function(f){var e;if(this.player){e=this.player.getPlugin("rangeslider");if(e){if(typeof f==="function"){return f.call(this,e)}else{if(typeof f==="string"){return e[f].call(e)}}}}return false},showRangeSlider:function(e){this.rangeSliderDo("show")},hideRangeSlider:function(){this.rangeSliderDo("hide")},lockRangeSlider:function(){this.rangeSliderDo("lock")},unlockRangeSlider:function(){this.rangeSliderDo("unlock")},syncRangeSlider:function(){this.rangeSliderDo(function(e){e.setValue(1,this.player.duration());e.setValue(0,this.player.currentTime())})},resetRangeSlider:function(){this.rangeSliderDo(function(e){e.setValue(1,this.player.duration());e.setValue(0,0)})},setRangeSliderValues:function(f,e){this.rangeSliderDo(function(g){g.setValue(1,e,true);g.setValue(0,f,true)})}});c.views.VideoPlayerView=a})(Catool,_V_);(function(d){var f=d.View;var e=d.utils.nl2br;var b=d.views.AlertView;var c=d.views.CommentEditorView;var a=f.extend({events:{"click .js-btn-edit":"onEdit","click .js-btn-delete":"onDelete"},tagName:"li",className:"note note-comment",template:_.template(['<div class="note-body">','<div class="note-byline">On <%= created_date %> <%= author %>:</div>','<div class="note-text"><%= body %></div>','<ul class="note-actions">','<li><a class="js-btn-edit <%= actionCls %>" href="javascript:;">Edit</a><li>','<li><a class="js-btn-delete <%= actionCls %>" href="javascript:;">Delete</a><li>',"</ul>","</div>"].join("")),initialize:function(){this.model.bind("change",this.render,this);this.model.bind("remove destroy",this.destroy,this)},render:function(){var g=this.model.toJSON();g.body=e(g.body);g.author=this.model.get("user").get("fullname");g.created_date=this.renderDate(g.created_unix);g.actionCls=(d.user.canModerate(this.model.get("user").get("id"))?"":"hide");this.$el.html(this.template(g));this.$el.attr("id","note-"+this.model.id);this.$el.addClass("note-"+this.model.id);if(this.model.get("highlightAdmin")){this.$el.addClass("role-admin")}return this},onEdit:function(g){g.preventDefault();g.stopPropagation();var h=this.getBodyEl();var j=this.getActionsEl();var i=new c({height:h.height(),content:this.model.get("body"),save:_.bind(this.onSaveEdit,this),cancel:_.bind(this.onCancelEdit,this)});h.html(i.render().el);j.hide();if(this.editor){this.editor.destroy()}this.editor=i},onSaveEdit:function(g){this.model.save({body:g},{wait:true,success:_.bind(this.render,this),error:_.bind(this._onSaveError,this)})},onCancelEdit:function(){var g=e(this.model.get("body"));this.getBodyEl().html(g);this.getActionsEl().show()},onDelete:function(g){g.preventDefault();g.stopPropagation();if(window.confirm("OK to delete comment?")){this.model.destroy({wait:true,error:_.bind(this._onDeleteError,this)})}},getBodyEl:function(){return this.$(".note-text").first()},getActionsEl:function(){return this.$(".note-actions").first()},destroy:function(){this.remove();this.unbind();this.model.unbind("remove destroy",this.destroy,this);this.model.unbind("change",this.render);if(this.editor){this.editor.destroy()}},renderDate:function(g){if(typeof g==="number"){return moment.unix(g).format("MMMM Do YYYY, h:mm a")}return"n/a"},_onDeleteError:function(h,j,g){var i=j.statusText?": "+j.statusText:"";this._showMsg("Error deleting comment"+i)},_onSaveError:function(h,j,g){var i=j.statusText?": "+j.statusText:"";this._showMsg("Error saving comment"+i)},_showMsg:function(h,g){this.$el.children(".action-messages").remove();this.$el.append('<div class="action-messages"></div>');this.$el.children(".action-messages").append(b.error(h).el)}});d.views.CommentView=a})(Catool);(function(b){var d=b.View;var a=b.models.Note;var c=d.extend({events:{"click .js-btn-cancel":"onCancelComment",submit:"onSaveComment"},className:"hide",template:_.template(['<form class="note-comment-form">','<textarea class="note-comment-text" rows="3"></textarea>',"<div>",'<button type="submit" class="js-btn-save btn btn-primary">Submit Comment</button>','<button class="js-btn-cancel btn">Cancel</button>',"</div>","</form>"].join("")),initialize:function(){},render:function(){this.$el.html(this.template());return this},onSaveComment:function(e){e.preventDefault();e.stopPropagation();var f=this;var i=this.$(".note-comment-text").val()||"";if($.trim(i).length===0){return}var h=new a();var g={target_id:this.model.get("target_id"),parent_id:this.model.get("id"),type:"comment",body:i};h.save({Note:g},{error:function(k,j){},success:function(k,j){f.model.collection.add(k);f.reset();f.toggle()}})},toggle:function(){this.$el.toggleClass("hide")},reset:function(){this.$(".note-comment-text").val("")},onCancelComment:function(e){e.preventDefault();e.stopPropagation();this.reset();this.toggle()},destroy:function(){this.remove();this.unbind()}});b.views.CommentFormView=c})(Catool);(function(e){var c=e.View;var a=e.models.Note;var d=e.views.CommentView;var j=e.views.CommentFormView;var f=e.views.AlertView;var i=e.views.CommentEditorView;var g=e.utils.TimeConverter;var b=e.utils.nl2br;var h=c.extend({events:{"click .js-note-header":"onToggleDetails","click .js-note-control-play":"onPlay","click .js-btn-reply":"onToggleComment","click .js-btn-comments":"onToggleComments","click .js-btn-edit":"onEdit","click .js-btn-delete":"onDelete"},tagName:"li",className:"note note-annotation",template:_.template(['<div class="note-header js-note-header">','<div class="note-col note-title"><%= title %></div>','<div class="note-col">','<div class="note-date"><%= created_date %></div>','<div class="note-author"><%= author %></div>',"</div>",'<div class="note-clear-float"></div>',"</div>",'<div class="note-body <%= expandedCls %>">','<div class="note-control note-control-play js-note-control-play">','<span class="note-play-label">Play</span>','<span class="note-play-time"><%= start_time %> / <%= end_time %></span>',"</div>",'<div class="note-byline">On <%= created_date %> <%= author %>:</div>','<div class="note-text"><%= body %></div>','<div class="note-tags hide"><b>Tags:</b> <%= tags %></div>','<ul class="note-actions">','<li><a class="js-btn-reply <%= replyCls %>" href="#">Comment</a></li>','<li><a class="js-btn-comments hide" href="#">Show Comments (<span class="note-num-comments"><%= numComments %></span>)</a></li>','<li><a class="js-btn-edit <%= actionCls %>" href="#">Edit</a></li>','<li><a class="js-btn-delete <%= actionCls %>" href="#">Delete</a></li>',"</ul>",'<ul class="notes note-comments"></ul>',"</div>"].join("")),editTemplate:_.template(['<form class="note-annotation-edit-form">','<textarea style="width: 95%"><%= body %></textarea>',"<p>",'<button class="save-edits btn-primary btn" style="margin-right: 10px">Save Changes</button>','<button class="cancel-edits btn">Cancel</button>',"</p>","</form>"].join("")),initialize:function(){this.views=[];this.commentForm=null;this.numComments=0;this.parentView=this.options.parentView;this.lockComments=this.options.lockComments;this.state={showComments:false,showDetails:false};_.extend(this.state,this.options.state);this.model.on("remove destroy",this.destroy,this);this.on("comment:destroy",this.onDestroyComment,this);this.on("comment:add",this.onAddComment,this)},render:function(){var l=this.getDataForTemplate();var k=new j({model:this.model});this.$el.attr("id","note-"+this.model.id);this.$el.html(this.template(l));if(this.model.get("highlightAdmin")){this.$el.addClass("role-admin")}if(this.model.hasTags()){this.$(".note-tags").removeClass("hide")}this.$(".note-comments").before(k.render().el);this.renderComments();this.commentForm=k;return this},renderComments:function(){var m,l;var k=[];var n=this.getComments();if(n.length>0){l="notes note-comments";m=$(this.make("div",{"class":l+(this.state.showComments?"":" hide")}));_.each(n,function(p){var o=new d({model:p});k.push(o);m.append(o.render().el)});this.$(".note-comments").replaceWith(m);this.$(".js-btn-comments").removeClass("hide");_.each(this.views,function(o){o.destroy()});this.views=k}else{this.$(".note-comments").addClass("hide")}return this},getDataForTemplate:function(){var n=this.model.toJSON();var l=this.model.get("segments");var m=l.first();var k=this.model.get("user").get("id");n.body=b(n.body);n.author=this.model.get("user").get("fullname");n.created_date="n/a";n.tags=n.tags.length>0?n.tags.join(", "):"";if(n.created_unix){n.created_date=moment.unix(n.created_unix).format("MMMM Do YYYY, h:mm a")}_(["start_time","end_time"]).each(function(p){if(m){var o=m.get(p);n[p]=g(o).toString()}});n.numComments=this.getNumComments();n.expandedCls=(this.state.showDetails?"":"hide");n.actionCls=(e.user.canModerate(k)?"":"hide");n.replyCls=this.lockComments?"hide":"";return n},getComments:function(){var k=this.model.getComments();k.sort(function(p,n){var m=p.get("created_unix");var o=n.get("created_unix");return m-o});return k},getNumComments:function(){var k=this.getComments();this.numComments=k.length;return this.numComments},toggleComment:function(){this.commentForm.toggle()},toggleDetails:function(m,k){var l=_.isBoolean(m)?m:this.state.showDetails;this.$(".note-body").toggleClass("hide",l);if(!k){this.trigger("toggle",this,this.model.id,l)}this.state.showDetails=!l},collapse:function(){this.toggleDetails(true,true);return this},expand:function(){this.toggleDetails(false,true);return this},collapseComments:function(){this.toggleComments(true,true);return this},expandComments:function(){if(this.getNumComments()>0){this.toggleComments(false,true)}return this},show:function(){this.$el.show();return this},hide:function(){this.$el.hide();return this},toggleComments:function(m,k){var l=_.isBoolean(m)?m:this.state.showComments;this.$(".note-comments").toggleClass("hide",l);if(!k){this.trigger("toggle",this,this.model.id,l)}this.state.showComments=!l},onToggleDetails:function(k){k.preventDefault();this.toggleDetails()},onToggleComment:function(k){k.preventDefault();this.toggleComment()},onToggleComments:function(k){k.preventDefault();this.toggleComments()},onPlay:function(k){k.preventDefault();this.parentView.trigger("playNote",this.model,this)},onDestroyComment:function(l,m,k){this.updateNumComments(-1)},onAddComment:function(l,m,k){this.updateNumComments(1);this.renderComments()},onEdit:function(k){k.preventDefault();k.stopPropagation();var l=this.getBodyEl();var n=this.getActionsEl();var m=new i({height:l.height(),content:this.model.get("body"),save:_.bind(this.onSaveEdit,this),cancel:_.bind(this.onCancelEdit,this)});l.html(m.render().el);n.hide();if(this.editor){this.editor.destroy()}this.editor=m},onSaveEdit:function(l){var k=this.getBodyEl();this.model.save({body:l},{wait:true,success:_.bind(this.render,this),error:function(){k.append(f.error("Error saving changes").el)}})},onCancelEdit:function(){var k=b(this.model.get("body"));this.getBodyEl().html(k);this.getActionsEl().show()},onDelete:function(k){k.preventDefault();if(window.confirm("OK to delete annotation?")){this.model.destroy({wait:true})}},updateNumComments:function(k){this.numComments+=k;this.$(".note-num-comments").html(this.numComments);if(this.numComments<1){this.$(".js-btn-comments").addClass("hide")}},getBodyEl:function(){return this.$(".note-text").first()},getActionsEl:function(){return this.$(".note-actions").first()},destroy:function(){this.parentView=null;if(this.commentForm){this.commentForm.destroy()}if(this.editor){this.editor.destroy()}this.remove();this.unbind();this.model.unbind()}});e.views.VideoAnnotationView=h})(Catool);(function(c){var e=c.View;var a=c.views.VideoAnnotationView;var d=c.utils.TimeConverter;var b=e.extend({events:{"click .notes-refresh":"onRefresh","click .notes-toggle":"onToggleDetails","click .notes-sync":"onToggleSync","submit .form-search":"onSearch","click .notes-sort a":"onSort"},emptyText:"No annotations to display.",emptyTemplate:_.template('<div class="notes notes-empty"><%= msg %></div>'),collapsed:true,initialize:function(f){this.views=[];this._viewStates={};this.searchInputEl=this.$("input.search-query");this.collapseBtnEl=this.$(".notes-toggle");this.syncBtnEl=this.$(".notes-sync");this.syncModel=f.syncModel;this.syncEnabled=f.syncEnabled;this.highlightAdmins=f.highlightAdmins;this.lockAnnotations=f.lockAnnotations;this.lockComments=f.lockComments;if(f.sortConfig){this.sortBy(f.sortConfig.key,f.sortConfig.dir)}else{this.sortBy("start-time","asc")}this.initCollection();this.updateSyncBtn();this.syncModel.initialize(this)},initCollection:function(){this.initHighlightAdmins();this.collection.on("reset",this.render,this);this.collection.on("add",this.onAddAnnotation,this);this.collection.on("add",this._relayToCommentView("comment:add"),this);this.collection.on("destroy",this._relayToCommentView("comment:destroy"),this)},initHighlightAdmins:function(){var f={};var g=function(j){var i=j.get("user");var h=i.get("id");if(f[h]){j.set({highlightAdmin:true},{silent:true})}};if(this.highlightAdmins&&this.highlightAdmins.length>0){_.each(this.highlightAdmins,function(h){f[h]=true});this.collection.on("change add sync",g);this.collection.on("reset",function(){this.each(g)});this.collection.each(g)}},_relayToCommentView:function(f){return function(h,i,g){_(this.views).each(function(j){if(h.isCommentOn(j.model)){j.trigger(f,h,i,g)}})}},onSort:function(g){var i,h,f;g.preventDefault();if(!this.syncEnabled){f=$(g.target);i=f.attr("data-sort");h=f.attr("data-sort-dir")||"asc";f.attr("data-sort-dir",h==="asc"?"desc":"asc");this.sortBy(i,h)}},sortBy:function(g,f){var h;if(!f||f.toLowerCase()==="asc"){h=function(k,j){return k<j?-1:k==j?0:1}}else{h=function(k,j){return k>j?-1:k==j?0:1}}var i={title:function(k,j){var m=(k.get("title")||"").toLowerCase();var l=(j.get("title")||"").toLowerCase();return h(m,l)},date:function(k,j){return h(k.get("created_unix"),j.get("created_unix"))},"start-time":function(k,j){var l={};_.each({a:k,b:j},function(n,m){var p=null;var o=n.get("segments")&&n.get("segments").first();if(o){p=d(o.get("start_time")).toSeconds()}l[m]=p===null?-1:p});return h(l.a,l.b)}};if(i[g]){this.collection.comparator=i[g];this.collection.sort()}},onRefresh:function(g){var f=this.$(".note-annotations");g.preventDefault();f.addClass("loading");this.collection.fetch({error:function(i,h){f.removeClass("loading");f.html("Loading failed.")},success:function(i,h){f.removeClass("loading")}})},onToggleSync:function(f){var g={sync:"note-icon-sync",unsync:"note-icon-unsync"};this.syncEnabled=!this.syncEnabled;this.updateSyncBtn();this.trigger("toggleSync",this.syncEnabled)},updateSyncBtn:function(){var f={sync:"note-icon-sync",unsync:"note-icon-unsync"};this.syncBtnEl.removeClass(this.syncEnabled?f.sync:f.unsync).addClass(this.syncEnabled?f.unsync:f.sync)},onSearch:function(f){var g=this.searchInputEl.val();f.preventDefault();this.collection.search({q:g})},onToggleDetails:function(f){var i=!this.collapsed;var h=true;var g=true;_(this.views).each(function(j){j.toggleDetails(i,g);j.toggleComments(h,g)});_(this._viewStates).each(function(k,j){k.showDetails=!i;k.showComments=false});this.collapsed=i;this.updateCollapseBtn()},updateCollapseBtn:function(){var f={collapse:"note-icon-collapse",expand:"note-icon-expand"};this.collapseBtnEl.removeClass(this.collapsed?f.collapse:f.expand).addClass(this.collapsed?f.expand:f.collapse)},onAddAnnotation:function(g,h,f){if(g.isAnnotation()){this.render()}},render:function(){var g=this.$(".note-annotations");var f=this.createViews();if(f.length>0){this.renderViews(f);this.destroyViews(this.views);this.views=f}else{g.html(this.emptyTemplate({msg:this.emptyText}))}this.afterRender();return this},afterRender:function(){this.focusNoteOnce()},focusNoteOnce:function(){var h=this;var g=this.options.showNoteId;var f="#note-"+g;var i=function(k){return k.id===g};var j;if(typeof g!=="undefined"){_.each(this.views,function(k){if(k.model.id===g||_.any(k.getComments(),i)){k.expand();k.expandComments();j=this.$(f).addClass("highlight");if(j.length===1){j.get(0).scrollIntoView();j.on("mouseover",function(){j.removeClass("highlight").addClass("unhighlight")})}delete h.options.showNoteId}})}},createViews:function(){var g=this;var j=this.lockComments;var k=this.collapsed;var h=this.collection.getAnnotations();var i=this._viewStates;var f=_.map(h,function(m){var n=i[m.id]||{};if(!n.hasOwnProperty("showDetails")){n.showDetails=!k}var l={state:n,model:m,lockComments:j,parentView:g};return new a(l)});return f},renderViews:function(g){var h=this;var f=$(window).height()-300;var j=this.$(".note-annotations");var k=$(this.make("div",{"class":"notes note-annotations"}));var i=_.map(g,function(l){l.render();l.on("toggle",h.onViewStateToggle,h);return l.el});j.replaceWith(k.append(i))},getViewByModel:function(f){return _(this.views).filter(function(g){return g.model.id===f})},getViewAt:function(f){return this.views[f]},destroyViews:function(f){_.each(f,function(g){g.destroy()})},onViewStateToggle:function(f,h,g){if((typeof h==="number"||typeof h=="string")&&h!==""){this._viewStates[h]=f.state}}});c.views.VideoNotesView=b})(Catool);(function(d){var h=d.models.Video;var e=d.collections.Notes;var a=d.View;var i=d.views.VideoNotesView;var g=d.views.VideoNoteFormView;var b=d.views.VideoPlayerView;var c=d.utils.NoteSyncModel;var f=a.extend({initialize:function(){var l=this.options;var q=l.data;var k=l.config;var p=new h(q.video);var m=new e(q.notes,{parse:true,targetModel:p});var n=new b({el:this.$(".notes-video-player"),playerId:"notes-video-player-1",model:p});var o=new g({el:this.$(".note-form-view"),collection:m,video:p,player:n});o.on("cancel",function(){$('a[data-target=".notes-view"]').tab("show")});var j=new i({el:this.$(".notes-view"),collection:m,sortConfig:k.sortNotesBy,showNoteId:k.noteId,highlightAdmins:k.highlightAdmins,lockComments:(d.user.isAdmin?false:k.lockComments),lockAnnotations:(d.user.isAdmin?false:k.lockAnnotations),syncEnabled:k.syncAnnotations,syncModel:new c({player:n})});this.videoNoteFormView=o;this.videoPlayerView=n;this.videoNotesView=j;this.views=[j,o,n];this.render()},render:function(){_(this.views).each(function(j){j.render()});this.afterRender();return this},afterRender:function(){var j=this;$('*[rel="tooltip"]').tooltip();$("#new_comment_tab").on("click",function(){j.videoPlayerView.clearSegmentHandler();j.videoPlayerView.showRangeSlider();j.videoPlayerView.syncRangeSlider()});$("#current_comments_tab").on("click",function(){j.videoPlayerView.hideRangeSlider()});return this}});d.views.VideoAppView=f})(Catool);(function(a){a.Catool=a.Catool||{};a.Catool.defineScript=function(b,c){this.scripts=this.scripts||{};this.scripts[b]=c};a.Catool.script=function(c,b){var d=this.scripts[c];b=b||{};if(!this.scripts.hasOwnProperty(c)){throw new Error("No such script: "+c)}return function(){var e=Array.prototype.slice.call(arguments);if(b.hasOwnProperty("data")){e.push(b.data)}d.apply(b.scope||a,e)}}})(window);Catool.defineScript("video-edit",function(c){var t=window._V_;var m="video-player-1";var s;var f={techOrder:["html5","flash","youtube"]};var l=c("#resource_url");var o=c("#resource-url-control-group");var v=c("#resource_duration");var r=c("#video-player-container-1");var h=c("#resource_file_type");var y=c("#playerErrorModal");var a=c("#videoDeleteModal");var b=c("#delete_video_button");var i=c("#validate_video");var k=function(z){var A=/^http:\/\/youtu\.be\/(.*)$/;var C,B;if(A.test(z)){C=A.exec(z);B=C[1];z="http://www.youtube.com/watch?v="+B}return z};var u=function(z){if(z){if(o.hasClass("error")){o.removeClass("error")}o.addClass("success")}else{if(o.hasClass("success")){o.removeClass("success")}o.addClass("error")}};var d=function(){var z=s.duration();if(q(z)){z=Math.floor(z);v.val(z)}};var q=function(z){return !isNaN(z)&&z>0};var x=function(){var z=parseInt(v.val().trim(),10);var A=q(z);u(A)};var e=function(z){y.modal("show")};var w=function(){var z=k(l.val().trim());var A=h.val();var B={type:A,src:z};v.val("");if(A&&z){l.val(z);r.show();s.src(B);s.play()}else{s.pause();r.hide();u(false)}};var j=function(){var B={"video/flv":/\.flv$/,"video/mp4":/(?:\.mp4|\.m4v)$/,"video/youtube":/^(?:http:\/\/www\.youtube\.com\/watch\?v=)|(?:http:\/\/youtu\.be)/};var C=l.val().trim();var A,z="";for(A in B){if(B.hasOwnProperty(A)){if(B[A].test(C)){z=A;break}}}h.val(z)};var n=function(z){z.preventDefault();a.modal("show")};var g=function(z){t(m,f,function(){s=this;s.addEvent("durationchange",d);s.addEvent("play",d);s.addEvent("error",e);if(z){z.apply(s,arguments)}})};var p=function(){x();setTimeout(p,750)};l.on("keyup",j);b.on("click",n);i.on("click",function(){j.apply(this,arguments);w.apply(this,arguments)});i.one("click",p);g()});Catool.defineScript("collection-edit",function(a){a("#delete_collection_button").on("click",function(b){b.preventDefault();a("#collectionDeleteModal").modal("show")})});Catool.defineScript("collection-edit-permissions",function(b,a){b("#users_table").dataTable({bPaginate:false,bLengthChange:false,bFilter:true,bSort:true,aaSorting:[[1,"asc"]],bInfo:false,bAutoWidth:false});b("#users_table .actions > .btn").on("click",function(c){c.preventDefault();var f=b(this).data("id");var d=b(this).data("action");var e=a[f];switch(d){case"edit":b("#user_collection_edit_id").val(e.UserCollection.id);b("#user_collection_edit_role input:radio").each(function(g,h){b(this).attr("checked",this.value==e.Role.id)});b("#user_collection_edit_name").html(e.User.name);b("#user_collection_edit_email").html(e.User.email);b("#editUserModal").modal("show");break;case"delete":b("#user_collection_delete_id").val(e.UserCollection.id);b("#user_collection_delete_name").html(e.User.name);b("#deleteUserModal").modal("show");break;default:break}})});Catool.defineScript("site-edit-permissions",function(b,a){b("#users_table").dataTable({bPaginate:false,bLengthChange:false,bFilter:true,bSort:true,aaSorting:[[1,"asc"]],bInfo:false,bAutoWidth:false});b("#users_table .actions > .btn").on("click",function(c){c.preventDefault();var f=b(this).data("id");var d=b(this).data("action");var e=a[f];switch(d){case"edit":b("#user_edit_id").val(e.User.id);b("#user_edit_role input:radio").each(function(g,h){b(this).attr("checked",this.value==e.Role.id)});b("#user_edit_name").val(e.User.name);b("#user_edit_email").val(e.User.email);b("#editUserModal").modal("show");break;case"delete":b("#user_delete_id").val(e.User.id);b("#user_delete_name").html(e.User.name);b("#deleteUserModal").modal("show");break;default:break}})});Catool.defineScript("collection-posts",function(a){a("#posts_table").dataTable({bPaginate:false,bLengthChange:false,bFilter:true,bSort:true,aaSorting:[[1,"desc"]],bInfo:false,bAutoWidth:false})});